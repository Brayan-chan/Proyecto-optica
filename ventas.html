<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ah Kim Pech - Ventas</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#f09d1f',
                        secondary: '#ffffff',
                        dark: '#121111',
                        lightGray: '#f5f5f5',
                        mediumGray: '#e0e0e0',
                        darkGray: '#757575'
                    },
                    boxShadow: {
                        'custom': '0 2px 5px rgba(0,0,0,0.1)',
                        'card': '0 1px 3px rgba(0,0,0,0.1)',
                        'modal': '0 4px 8px rgba(0,0,0,0.2)'
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --primary-color: #f09d1f;
            --secondary-color: #ffffff;
            --dark-color: #121111;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #757575;
        }
        
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        /* Dark mode styles */
        .dark body {
            background-color: #1a1a1a;
            color: #f5f5f5;
        }
        
        .dark .data-table th {
            background-color: #d18b1a;
        }
        
        .dark .data-table {
            background-color: #2a2a2a;
            color: #f5f5f5;
        }
        
        .dark .data-table td {
            border-bottom: 1px solid #3a3a3a;
        }
        
        .dark .data-table tr:hover {
            background-color: #333333;
        }
        
        .dark .modal-content {
            background-color: #2a2a2a;
            color: #f5f5f5;
        }
        
        .dark input, .dark select, .dark textarea {
            background-color: #333333;
            color: #f5f5f5;
            border-color: #444444;
        }
        
        /* Status styles */
        .status-pendiente { 
            @apply text-amber-500 font-semibold;
        }
        .status-parcial { 
            @apply text-blue-500 font-semibold;
        }
        .status-pagada { 
            @apply text-green-600 font-semibold;
        }
        .status-cancelada { 
            @apply text-red-600 font-semibold;
        }
        
        /* Badge styles */
        .badge {
            @apply inline-block py-1 px-2.5 rounded-full text-xs font-bold;
        }
        .badge-success { 
            @apply bg-green-600 text-white;
        }
        .badge-secondary { 
            @apply bg-gray-500 text-white;
        }
        
        /* Transition effects */
        .btn-action {
            transition: all 0.2s ease;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
        }
        
        .btn-action:active {
            transform: translateY(0);
        }
        
        /* Product item styles */
        .producto-item {
            @apply border border-mediumGray dark:border-gray-700 rounded-lg p-4 mb-4;
        }
        
        /* Print styles */
        @media print {
            .main-header, .main-nav, .actions, #closeSaleBtn, .btn-primary {
                display: none !important;
            }
            
            .sale-details {
                padding: 0;
                margin: 0;
            }
            
            .modal-content {
                box-shadow: none;
                margin: 0;
                width: 100%;
                max-width: 100%;
            }
        }
    </style>
</head>
<body class="bg-lightGray dark:bg-gray-900 text-dark dark:text-white">
    <!-- Header -->
    <header class="main-header">
        <img src="img/iconoAKPV1.png" alt="Logo" id="logo">
        <div class="logo">
            <h1>Servicios Ópticos</h1>
            <h2>Ah Kim Pech</h2>
        </div>
        <nav class="main-nav">
            <ul>
                <li><a href="inventario.html">Inventario</a></li>
                <li><a href="ventas.html">Ventas</a></li>
                <li><a href="clientes.html">Clientes</a></li>
                <li><a href="#" id="logoutBtn">Cerrar sesión</a></li>
            </ul>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 max-w-7xl">
        <h2 class="text-2xl font-bold mb-6 border-b-2 border-primary pb-2">Ventas</h2>
        
        <!-- Actions Bar -->
        <div class="actions flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <button id="addSaleBtn" class="btn-action bg-primary hover:bg-primary/80 text-white py-2 px-4 rounded shadow-sm flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Nueva venta
            </button>
            <div class="search-box w-full sm:w-auto flex">
                <input type="text" id="searchVenta" placeholder="Buscar por cliente..." class="w-full sm:w-64 py-2 px-3 border border-mediumGray rounded-l-md text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:border-gray-700">
                <button class="btn-secondary bg-mediumGray hover:bg-mediumGray/80 py-2 px-4 rounded-r-md flex items-center" id="searchVentaBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Sales Table -->
        <div class="overflow-x-auto shadow-card rounded-lg">
            <table class="data-table w-full bg-white dark:bg-gray-800 rounded-lg">
                <thead>
                    <tr>
                        <th class="py-3 px-4 text-left bg-primary text-white rounded-tl-lg">ID</th>
                        <th class="py-3 px-4 text-left bg-primary text-white">Fecha</th>
                        <th class="py-3 px-4 text-left bg-primary text-white">Cliente</th>
                        <th class="py-3 px-4 text-left bg-primary text-white">Total</th>
                        <th class="py-3 px-4 text-left bg-primary text-white">Abono</th>
                        <th class="py-3 px-4 text-left bg-primary text-white">Pendiente</th>
                        <th class="py-3 px-4 text-left bg-primary text-white">Estado</th>
                        <th class="py-3 px-4 text-left bg-primary text-white">Convenio</th>
                        <th class="py-3 px-4 text-left bg-primary text-white rounded-tr-lg">Acciones</th>
                    </tr>
                </thead>
                <tbody id="ventasTableBody" class="divide-y divide-mediumGray dark:divide-gray-700">
                    <!-- Data will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </main>

    <!-- New Sale Modal -->
    <div id="saleModal" class="modal">
        <div class="modal-content bg-white dark:bg-gray-800 w-11/12 md:w-3/4 max-w-4xl mx-auto mt-10 rounded-lg shadow-modal p-6">
            <div class="flex justify-between items-center mb-4 border-b border-mediumGray dark:border-gray-700 pb-3">
                <h3 id="modalTitle" class="text-xl font-semibold">Registrar Nueva Venta</h3>
                <span class="close text-2xl cursor-pointer hover:text-gray-600 dark:hover:text-gray-300">&times;</span>
            </div>
            
            <form id="saleForm" class="space-y-4">
                <input type="hidden" id="saleId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="clienteId" class="block mb-1 font-medium">Cliente</label>
                        <select id="clienteId" class="w-full p-2 border border-mediumGray rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600" required>
                            <!-- Options will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fechaVenta" class="block mb-1 font-medium">Fecha</label>
                        <input type="date" id="fechaVenta" class="w-full p-2 border border-mediumGray rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600" required>
                    </div>
                </div>
                
                <div class="form-group p-3 bg-lightGray dark:bg-gray-700 rounded-lg" id="convenioGroup">
                    <label for="esConvenio" class="flex items-center font-medium">
                        <input type="checkbox" id="esConvenio" class="mr-2" disabled>
                        Cliente con convenio
                    </label>
                    <div id="infoConvenio" class="hidden mt-2 p-3 bg-white dark:bg-gray-600 rounded border border-mediumGray dark:border-gray-600">
                        <p><strong>Empresa:</strong> <span id="empresaConvenio">-</span></p>
                    </div>
                </div>
                
                <!-- Products Container -->
                <div id="productosContainer" class="space-y-4">
                    <!-- First product item - will be cloned for additional products -->
                </div>
                
                <button type="button" id="addProductoBtn" class="flex items-center px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-md transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Agregar otro producto
                </button>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-mediumGray dark:border-gray-700">
                    <div class="form-group">
                        <label for="total" class="block mb-1 font-medium">Total</label>
                        <input type="number" step="0.01" id="total" class="w-full p-2 border border-mediumGray rounded-md text-base font-bold focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600" readonly>
                    </div>
                    <div class="form-group">
                        <label for="abono" class="block mb-1 font-medium">Abono inicial</label>
                        <input type="number" step="0.01" id="abono" value="0" class="w-full p-2 border border-mediumGray rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="observaciones" class="block mb-1 font-medium">Observaciones</label>
                    <textarea id="observaciones" rows="2" class="w-full p-2 border border-mediumGray rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600"></textarea>
                </div>
                
                <div class="flex justify-end space-x-2 pt-4 border-t border-mediumGray dark:border-gray-700">
                    <button type="button" class="close-modal py-2 px-4 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Cancelar</button>
                    <button type="submit" class="btn-primary py-2 px-4 bg-primary hover:bg-primary/80 text-white rounded transition-colors">Registrar venta</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Create product template
            const productoTemplate = `
                <div class="producto-item">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-medium text-lg">Producto 1</h4>
                        <button type="button" class="btn-remove-producto text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div class="form-group">
                            <label for="tipoProducto1" class="block mb-1 font-medium">Tipo de producto</label>
                            <select id="tipoProducto1" class="tipoProducto w-full p-2 border border-mediumGray rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600" required>
                                <option value="">Seleccione tipo</option>
                                <option value="Producto">Producto</option>
                                <option value="Armazon">Armazón</option>
                            </select>
                        </div>
                        <div class="form-group producto-select" style="display: none;">
                            <label class="block mb-1 font-medium">Producto</label>
                            <select class="productoSelect w-full p-2 border border-mediumGray rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                                <option value="">Seleccione un producto</option>
                            </select>
                        </div>
                        <div class="form-group armazon-select" style="display: none;">
                            <label class="block mb-1 font-medium">Armazón</label>
                            <select class="armazonSelect w-full p-2 border border-mediumGray rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                                <option value="">Seleccione un armazón</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-group">
                            <label class="block mb-1 font-medium">Cantidad</label>
                            <input type="number" class="cantidad w-full p-2 border border-mediumGray rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label class="block mb-1 font-medium">Precio unitario</label>
                            <input type="number" step="0.01" class="precioUnitario w-full p-2 border border-mediumGray rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600" required>
                        </div>
                        <div class="form-group">
                            <label class="block mb-1 font-medium">Subtotal</label>
                            <input type="number" step="0.01" class="subtotal w-full p-2 border border-mediumGray rounded-md text-base font-semibold bg-lightGray dark:bg-gray-900" readonly>
                        </div>
                    </div>
                </div>
            `;
            
            // Set initial product template
            document.getElementById('productosContainer').innerHTML = productoTemplate;
            
            // Cargar ventas desde la API
            try {
                const response = await fetch('http://localhost:3000/api/ventas');
                const ventasData = await response.json();
                
                // Llenar la tabla de ventas
                const tableBody = document.getElementById('ventasTableBody');
                tableBody.innerHTML = ''; // Limpiar tabla
                
                ventasData.forEach(venta => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-lightGray dark:hover:bg-gray-700 transition-colors';
                    
                    // Verificar si el cliente tiene convenio
                    const tieneConvenio = venta.cliente_id ? 
                        `<span class="badge ${venta.convenio ? 'badge-success' : 'badge-secondary'}">${venta.convenio ? 'Sí' : 'No'}</span>` : 
                        '<span class="badge badge-secondary">N/A</span>';
                    
                    row.innerHTML = `
                        <td class="py-3 px-4">${venta.id}</td>
                        <td class="py-3 px-4">${venta.fecha}</td>
                        <td class="py-3 px-4">${venta.cliente_nombre || 'Cliente no registrado'}</td>
                        <td class="py-3 px-4 font-medium">$${parseFloat(venta.total).toFixed(2)}</td>
                        <td class="py-3 px-4">$${parseFloat(venta.abono).toFixed(2)}</td>
                        <td class="py-3 px-4 ${parseFloat(venta.saldo) > 0 ? 'text-red-500 font-medium' : ''}">$${parseFloat(venta.saldo).toFixed(2)}</td>
                        <td class="py-3 px-4"><span class="status-${venta.estado.toLowerCase()}">${venta.estado}</span></td>
                        <td class="py-3 px-4">${tieneConvenio}</td>
                        <td class="py-3 px-4">
                            <div class="flex space-x-2">
                                <button class="btn-view btn-action bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded-md flex items-center" data-id="${venta.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                    </svg>
                                    Ver
                                </button>
                                ${venta.estado !== 'Cancelada' && venta.estado !== 'Pagada' ? 
                                  `<button class="btn-pay btn-action bg-green-500 hover:bg-green-600 text-white py-1 px-2 rounded-md flex items-center" data-id="${venta.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2z" />
                                    </svg>
                                    Pago
                                   </button>` : ''}
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error al cargar ventas:', error);
                alert('Error al cargar los datos de ventas');
            }
            
            // Cargar clientes para el select
            let clientesData = [];
            try {
                const clientesResponse = await fetch('http://localhost:3000/api/clientes');
                clientesData = await clientesResponse.json();
                
                const clienteSelect = document.getElementById('clienteId');
                clienteSelect.innerHTML = '<option value="">Seleccione un cliente</option>';
                
                clientesData.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nombre;
                    option.dataset.convenio = cliente.convenio ? 'true' : 'false';
                    option.dataset.empresaId = cliente.empresa_id || '';
                    option.dataset.empresaNombre = cliente.empresa_nombre || '';
                    clienteSelect.appendChild(option);
                });
                
                // Manejar cambio en el select de cliente para mostrar info de convenio
                clienteSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const esConvenio = selectedOption.dataset.convenio === 'true';
                    const empresaNombre = selectedOption.dataset.empresaNombre;
                    
                    document.getElementById('esConvenio').checked = esConvenio;
                    
                    if (esConvenio && empresaNombre) {
                        document.getElementById('empresaConvenio').textContent = empresaNombre;
                        document.getElementById('infoConvenio').style.display = 'block';
                    } else {
                        document.getElementById('infoConvenio').style.display = 'none';
                    }
                });
            } catch (error) {
                console.error('Error al cargar clientes:', error);
            }
            
            // Cargar productos y armazones para los selects
            let productosData = [];
            let armazonesData = [];
            try {
                // Productos
                const productosResponse = await fetch('http://localhost:3000/api/productos');
                productosData = await productosResponse.json();
                
                // Armazones
                const armazonesResponse = await fetch('http://localhost:3000/api/armazones');
                armazonesData = await armazonesResponse.json();
                
                // Llenar los selects iniciales
                actualizarSelectsProductos();
                
            } catch (error) {
                console.error('Error al cargar productos y armazones:', error);
            }
            
            // Función para actualizar los selects de productos y armazones
            function actualizarSelectsProductos() {
                document.querySelectorAll('.productoSelect').forEach(select => {
                    select.innerHTML = '<option value="">Seleccione un producto</option>';
                    productosData.forEach(producto => {
                        const option = document.createElement('option');
                        option.value = producto.id;
                        option.textContent = `${producto.nombre} - $${producto.precio_venta}`;
                        option.dataset.precio = producto.precio_venta;
                        select.appendChild(option);
                    });
                });
                
                document.querySelectorAll('.armazonSelect').forEach(select => {
                    select.innerHTML = '<option value="">Seleccione un armazón</option>';
                    armazonesData.forEach(armazon => {
                        const option = document.createElement('option');
                        option.value = armazon.id;
                        option.textContent = `${armazon.nombre} (${armazon.marca || 'Sin marca'}) - $${armazon.precio_venta}`;
                        option.dataset.precio = armazon.precio_venta;
                        select.appendChild(option);
                    });
                });
            }
            
            // Manejar cambio en tipo de producto
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('tipoProducto')) {
                    const productoItem = e.target.closest('.producto-item');
                    const productoSelect = productoItem.querySelector('.producto-select');
                    const armazonSelect = productoItem.querySelector('.armazon-select');
                    
                    // Ocultar ambos selects
                    productoSelect.style.display = 'none';
                    armazonSelect.style.display = 'none';
                    
                    // Mostrar el select correspondiente
                    if (e.target.value === 'Producto') {
                        productoSelect.style.display = 'block';
                    } else if (e.target.value === 'Armazon') {
                        armazonSelect.style.display = 'block';
                    }
                    
                    // Resetear precio y subtotal
                    const precioInput = productoItem.querySelector('.precioUnitario');
                    const subtotalInput = productoItem.querySelector('.subtotal');
                    precioInput.value = '';
                    subtotalInput.value = '';
                    
                    // Actualizar total
                    actualizarTotalVenta();
                }
                
                // Actualizar precio al seleccionar producto o armazón
                if (e.target.classList.contains('productoSelect') || e.target.classList.contains('armazonSelect')) {
                    const productoItem = e.target.closest('.producto-item');
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    
                    if (selectedOption.value) {
                        const precioInput = productoItem.querySelector('.precioUnitario');
                        precioInput.value = selectedOption.dataset.precio;
                        
                        // Actualizar subtotal
                        const cantidadInput = productoItem.querySelector('.cantidad');
                        const subtotalInput = productoItem.querySelector('.subtotal');
                        const cantidad = parseInt(cantidadInput.value) || 0;
                        const precio = parseFloat(precioInput.value) || 0;
                        subtotalInput.value = (cantidad * precio).toFixed(2);
                        
                        // Actualizar total
                        actualizarTotalVenta();
                    }
                }
                
                // Actualizar subtotal al cambiar cantidad o precio
                if (e.target.classList.contains('cantidad') || e.target.classList.contains('precioUnitario')) {
                    const productoItem = e.target.closest('.producto-item');
                    const cantidadInput = productoItem.querySelector('.cantidad');
                    const precioInput = productoItem.querySelector('.precioUnitario');
                    const subtotalInput = productoItem.querySelector('.subtotal');
                    
                    const cantidad = parseInt(cantidadInput.value) || 0;
                    const precio = parseFloat(precioInput.value) || 0;
                    subtotalInput.value = (cantidad * precio).toFixed(2);
                    
                    // Actualizar total
                    actualizarTotalVenta();
                }
            });
            
            // Función para actualizar el total de la venta
            function actualizarTotalVenta() {
                let total = 0;
                document.querySelectorAll('.subtotal').forEach(input => {
                    total += parseFloat(input.value) || 0;
                });
                document.getElementById('total').value = total.toFixed(2);
            }
            
            // Agregar otro producto
            document.getElementById('addProductoBtn').addEventListener('click', function() {
                const productosContainer = document.getElementById('productosContainer');
                const productoItems = productosContainer.querySelectorAll('.producto-item');
                const nuevoIndex = productoItems.length + 1;
                
                // Crear nuevo elemento
                const nuevoProducto = document.createElement('div');
                nuevoProducto.innerHTML = productoTemplate;
                nuevoProducto.firstElementChild.querySelector('h4').textContent = `Producto ${nuevoIndex}`;
                
                productosContainer.appendChild(nuevoProducto.firstElementChild);
                
                // Actualizar ids para evitar duplicados
                const nuevoProductoItem = productosContainer.lastElementChild;
                nuevoProductoItem.querySelector('.tipoProducto').id = `tipoProducto${nuevoIndex}`;
                
                // Actualizar los selects del nuevo producto
                actualizarSelectsProductos();
            });
            
            // Eliminar producto
            document.addEventListener('click', function(e) {
                if (e.target.closest('.btn-remove-producto')) {
                    if (document.querySelectorAll('.producto-item').length > 1) {
                        const productoItem = e.target.closest('.producto-item');
                        productoItem.remove();
                        
                        // Renumerar los productos
                        document.querySelectorAll('.producto-item h4').forEach((header, index) => {
                            header.textContent = `Producto ${index + 1}`;
                        });
                        
                        // Actualizar total
                        actualizarTotalVenta();
                    } else {
                        alert('Debe haber al menos un producto en la venta');
                    }
                }
            });
            
            // Mostrar modal para nueva venta
            document.getElementById('addSaleBtn').addEventListener('click', function() {
                document.getElementById('modalTitle').textContent = 'Registrar Nueva Venta';
                document.getElementById('saleForm').reset();
                document.getElementById('saleId').value = '';
                document.getElementById('infoConvenio').style.display = 'none';
                
                // Establecer fecha actual
                const hoy = new Date().toISOString().split('T')[0];
                document.getElementById('fechaVenta').value = hoy;
                
                // Resetear productos - usar el template
                const productosContainer = document.getElementById('productosContainer');
                productosContainer.innerHTML = productoTemplate;
                
                // Actualizar los selects
                actualizarSelectsProductos();
                
                document.getElementById('saleModal').style.display = 'block';
            });
            
            // Manejar envío del formulario de venta
            document.getElementById('saleForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Recopilar datos de productos
                const detalles = [];
                const productosItems = document.querySelectorAll('.producto-item');
                
                for (const item of productosItems) {
                    const tipoProducto = item.querySelector('.tipoProducto').value;
                    let productoId = null;
                    let armazonId = null;
                    
                    if (tipoProducto === 'Producto') {
                        productoId = item.querySelector('.productoSelect').value;
                        if (!productoId) {
                            alert('Por favor seleccione un producto');
                            return;
                        }
                    } else if (tipoProducto === 'Armazon') {
                        armazonId = item.querySelector('.armazonSelect').value;
                        if (!armazonId) {
                            alert('Por favor seleccione un armazón');
                            return;
                        }
                    } else {
                        alert('Por favor seleccione un tipo de producto');
                        return;
                    }
                    
                    const cantidad = parseInt(item.querySelector('.cantidad').value);
                    const precioUnitario = parseFloat(item.querySelector('.precioUnitario').value);
                    const subtotal = parseFloat(item.querySelector('.subtotal').value);
                    
                    detalles.push({
                        tipoProducto,
                        productoId,
                        armazonId,
                        cantidad,
                        precioUnitario,
                        subtotal
                    });
                }
                
                // Verificar si el cliente tiene convenio
                const clienteId = document.getElementById('clienteId').value;
                let convenio = false;
                let empresaId = null;
                
                if (clienteId) {
                    const clienteOption = document.querySelector(`#clienteId option[value="${clienteId}"]`);
                    convenio = clienteOption.dataset.convenio === 'true';
                    empresaId = clienteOption.dataset.empresaId || null;
                }
                
                const ventaData = {
                    clienteId,
                    fecha: document.getElementById('fechaVenta').value,
                    total: parseFloat(document.getElementById('total').value),
                    abono: parseFloat(document.getElementById('abono').value) || 0,
                    observaciones: document.getElementById('observaciones').value,
                    detalles,
                    convenio,
                    empresaId
                };
                
                try {
                    const response = await fetch('http://localhost:3000/api/ventas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(ventaData)
                    });
                    
                    if (response.ok) {
                        alert('Venta registrada correctamente');
                        document.getElementById('saleModal').style.display = 'none';
                        // Recargar la página para mostrar los cambios
                        location.reload();
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.message}`);
                    }
                } catch (error) {
                    console.error('Error al registrar venta:', error);
                    alert('Error al conectar con el servidor');
                }
            });
            
            // Manejar clics en botones de la tabla
            document.getElementById('ventasTableBody').addEventListener('click', async function(e) {
                const btnView = e.target.closest('.btn-view');
                const btnPay = e.target.closest('.btn-pay');
                
                if (!btnView && !btnPay) {
                    return;
                }
                
                if (btnView) {
                    const id = btnView.getAttribute('data-id');
                    
                    try {
                        const response = await fetch(`http://localhost:3000/api/ventas/${id}`);
                        const venta = await response.json();
                        
                        // Crear modal para ver detalles de venta
                        const modalHTML = `
                            <div id="viewSaleModal" class="modal">
                                <div class="modal-content bg-white dark:bg-gray-800 w-11/12 md:w-3/4 max-w-4xl mx-auto mt-10 rounded-lg shadow-modal p-6">
                                    <div class="flex justify-between items-center mb-4 border-b border-mediumGray dark:border-gray-700 pb-3">
                                        <h3 class="text-xl font-semibold">Detalles de Venta #${venta.id}</h3>
                                        <span class="close text-2xl cursor-pointer hover:text-gray-600 dark:hover:text-gray-300">&times;</span>
                                    </div>
                                    <div class="sale-details space-y-6">
                                        <div class="sale-info grid grid-cols-1 md:grid-cols-2 gap-4 bg-lightGray dark:bg-gray-700 p-4 rounded-lg">
                                            <div>
                                                <p class="mb-2"><span class="font-semibold">Cliente:</span> ${venta.cliente_nombre || 'Cliente no registrado'}</p>
                                                <p class="mb-2"><span class="font-semibold">Fecha:</span> ${venta.fecha}</p>
                                                <p class="mb-2"><span class="font-semibold">Estado:</span> <span class="status-${venta.estado.toLowerCase()}">${venta.estado}</span></p>
                                                ${venta.convenio ? `<p class="mb-2"><span class="font-semibold">Convenio:</span> Sí (${venta.empresa_nombre || 'Sin empresa'})</p>` : ''}
                                            </div>
                                            <div>
                                                <p class="mb-2"><span class="font-semibold">Total:</span> $${parseFloat(venta.total).toFixed(2)}</p>
                                                <p class="mb-2"><span class="font-semibold">Abono:</span> $${parseFloat(venta.abono).toFixed(2)}</p>
                                                <p class="mb-2"><span class="font-semibold">Saldo:</span> <span class="${parseFloat(venta.saldo) > 0 ? 'text-red-500 font-medium' : ''}">\$${parseFloat(venta.saldo).toFixed(2)}</span></p>
                                                ${venta.observaciones ? `<p class="mb-2"><span class="font-semibold">Observaciones:</span> ${venta.observaciones}</p>` : ''}
                                            </div>
                                        </div>
                                        
                                        <div class="sale-items">
                                            <h4 class="text-lg font-semibold mb-3 border-b border-mediumGray dark:border-gray-700 pb-2">Productos</h4>
                                            <div class="overflow-x-auto">
                                                <table class="data-table w-full bg-white dark:bg-gray-800 rounded-lg">
                                                    <thead>
                                                        <tr>
                                                            <th class="py-2 px-4 text-left bg-primary text-white rounded-tl-lg">Tipo</th>
                                                            <th class="py-2 px-4 text-left bg-primary text-white">Producto</th>
                                                            <th class="py-2 px-4 text-left bg-primary text-white">Cantidad</th>
                                                            <th class="py-2 px-4 text-left bg-primary text-white">Precio</th>
                                                            <th class="py-2 px-4 text-left bg-primary text-white rounded-tr-lg">Subtotal</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="divide-y divide-mediumGray dark:divide-gray-700">
                                                        ${venta.detalles.map(detalle => `
                                                            <tr class="hover:bg-lightGray dark:hover:bg-gray-700">
                                                                <td class="py-2 px-4">${detalle.tipo_producto}</td>
                                                                <td class="py-2 px-4">${detalle.producto_nombre || detalle.armazon_nombre || 'N/A'}</td>
                                                                <td class="py-2 px-4">${detalle.cantidad}</td>
                                                                <td class="py-2 px-4">$${parseFloat(detalle.precio_unitario).toFixed(2)}</td>
                                                                <td class="py-2 px-4 font-medium">$${parseFloat(detalle.subtotal).toFixed(2)}</td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        
                                        ${venta.pagos && venta.pagos.length > 0 ? `
                                            <div class="sale-payments">
                                                <h4 class="text-lg font-semibold mb-3 border-b border-mediumGray dark:border-gray-700 pb-2">Historial de Pagos</h4>
                                                <div class="overflow-x-auto">
                                                    <table class="data-table w-full bg-white dark:bg-gray-800 rounded-lg">
                                                        <thead>
                                                            <tr>
                                                                <th class="py-2 px-4 text-left bg-primary text-white rounded-tl-lg">Fecha</th>
                                                                <th class="py-2 px-4 text-left bg-primary text-white">Monto</th>
                                                                <th class="py-2 px-4 text-left bg-primary text-white">Método</th>
                                                                <th class="py-2 px-4 text-left bg-primary text-white rounded-tr-lg">Referencia</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="divide-y divide-mediumGray dark:divide-gray-700">
                                                            ${venta.pagos.map(pago => `
                                                                <tr class="hover:bg-lightGray dark:hover:bg-gray-700">
                                                                    <td class="py-2 px-4">${pago.fecha}</td>
                                                                    <td class="py-2 px-4 font-medium">$${parseFloat(pago.monto).toFixed(2)}</td>
                                                                    <td class="py-2 px-4">${pago.metodo_pago}</td>
                                                                    <td class="py-2 px-4">${pago.referencia || 'N/A'}</td>
                                                                </tr>
                                                            `).join('')}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        ` : ''}
                                        
                                        <div class="sale-actions flex justify-end space-x-4 pt-4 border-t border-mediumGray dark:border-gray-700">
                                            <button class="btn-primary py-2 px-4 bg-primary hover:bg-primary/80 text-white rounded transition-colors flex items-center" id="printSaleBtn">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                                </svg>
                                                Imprimir
                                            </button>
                                            <button class="py-2 px-4 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors flex items-center" id="closeSaleBtn">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                                Cerrar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Agregar modal al DOM
                        const modalContainer = document.createElement('div');
                        modalContainer.innerHTML = modalHTML;
                        document.body.appendChild(modalContainer);
                        
                        // Mostrar modal
                        document.getElementById('viewSaleModal').style.display = 'block';
                        
                        // Manejar cierre de modal
                        document.querySelector('#viewSaleModal .close').addEventListener('click', function() {
                            document.getElementById('viewSaleModal').remove();
                        });
                        
                        document.getElementById('closeSaleBtn').addEventListener('click', function() {
                            document.getElementById('viewSaleModal').remove();
                        });
                        
                        // Manejar impresión
                        document.getElementById('printSaleBtn').addEventListener('click', function() {
                            window.print();
                        });
                        
                    } catch (error) {
                        console.error('Error al cargar detalles de venta:', error);
                        alert('Error al cargar los detalles de la venta');
                    }
                }
                
                if (btnPay) {
                    const id = btnPay.getAttribute('data-id');
                    
                    try {
                        const response = await fetch(`http://localhost:3000/api/ventas/${id}`);
                        const venta = await response.json();
                        
                        // Crear modal para registrar pago
                        const modalHTML = `
                            <div id="paymentModal" class="modal">
                                <div class="modal-content bg-white dark:bg-gray-800 w-11/12 md:w-1/2 max-w-lg mx-auto mt-16 rounded-lg shadow-modal p-6">
                                    <div class="flex justify-between items-center mb-4 border-b border-mediumGray dark:border-gray-700 pb-3">
                                        <h3 class="text-xl font-semibold">Registrar Pago</h3>
                                        <span class="close text-2xl cursor-pointer hover:text-gray-600 dark:hover:text-gray-300">&times;</span>
                                    </div>
                                    <form id="paymentForm" class="space-y-4">
                                        <input type="hidden" id="ventaId" value="${venta.id}">
                                        
                                        <div class="p-3 bg-lightGray dark:bg-gray-700 rounded-lg mb-4">
                                            <div class="font-medium mb-2">Resumen de la venta</div>
                                            <div class="grid grid-cols-2 gap-2">
                                                <div>Total:</div>
                                                <div class="text-right font-medium">$${parseFloat(venta.total).toFixed(2)}</div>
                                                <div>Pagado:</div>
                                                <div class="text-right">$${parseFloat(venta.abono).toFixed(2)}</div>
                                                <div>Saldo:</div>
                                                <div class="text-right font-bold text-red-500">$${parseFloat(venta.saldo).toFixed(2)}</div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="saldoActual" class="block mb-1 font-medium">Saldo pendiente</label>
                                            <input type="number" id="saldoActual" value="${venta.saldo}" class="w-full p-2 border border-mediumGray rounded-md text-base bg-lightGray dark:bg-gray-700 font-bold dark:border-gray-600" readonly>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="montoPago" class="block mb-1 font-medium">Monto a pagar</label>
                                            <input type="number" step="0.01" id="montoPago" class="w-full p-2 border border-mediumGray rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600" required max="${venta.saldo}">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="metodoPago" class="block mb-1 font-medium">Método de pago</label>
                                            <select id="metodoPago" class="w-full p-2 border border-mediumGray rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600" required>
                                                <option value="Efectivo">Efectivo</option>
                                                <option value="Tarjeta">Tarjeta</option>
                                                <option value="Transferencia">Transferencia</option>
                                                <option value="Otro">Otro</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="referenciaPago" class="block mb-1 font-medium">Referencia (opcional)</label>
                                            <input type="text" id="referenciaPago" class="w-full p-2 border border-mediumGray rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                                        </div>
                                        
                                        <div class="flex justify-end space-x-2 pt-4 border-t border-mediumGray dark:border-gray-700">
                                            <button type="button" class="close-modal py-2 px-4 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Cancelar</button>
                                            <button type="submit" class="btn-primary py-2 px-4 bg-primary hover:bg-primary/80 text-white rounded transition-colors">Registrar pago</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        `;
                        
                        // Agregar modal al DOM
                        const modalContainer = document.createElement('div');
                        modalContainer.innerHTML = modalHTML;
                        document.body.appendChild(modalContainer);
                        
                        // Mostrar modal
                        document.getElementById('paymentModal').style.display = 'block';
                        
                        // Manejar cierre de modal
                        document.querySelector('#paymentModal .close').addEventListener('click', function() {
                            document.getElementById('paymentModal').remove();
                        });
                        
                        document.querySelector('#paymentModal .close-modal').addEventListener('click', function() {
                            document.getElementById('paymentModal').remove();
                        });
                        
                        // Manejar envío del formulario de pago
                        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
                            e.preventDefault();
                            
                            const pagoData = {
                                monto: parseFloat(document.getElementById('montoPago').value),
                                metodoPago: document.getElementById('metodoPago').value,
                                referencia: document.getElementById('referenciaPago').value
                            };
                            
                            try {
                                const response = await fetch(`http://localhost:3000/api/ventas/${id}/pagos`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(pagoData)
                                });
                                
                                if (response.ok) {
                                    alert('Pago registrado correctamente');
                                    document.getElementById('paymentModal').remove();
                                    // Recargar la página para mostrar los cambios
                                    location.reload();
                                } else {
                                    const error = await response.json();
                                    alert(`Error: ${error.message}`);
                                }
                            } catch (error) {
                                console.error('Error al registrar pago:', error);
                                alert('Error al conectar con el servidor');
                            }
                        });
                        
                    } catch (error) {
                        console.error('Error al cargar datos de venta:', error);
                        alert('Error al cargar los datos de la venta');
                    }
                }
            });
            
            // Búsqueda de ventas
            document.getElementById('searchVentaBtn').addEventListener('click', function() {
                buscarVentas();
            });
            
            document.getElementById('searchVenta').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    buscarVentas();
                }
            });
            
            function buscarVentas() {
                const searchTerm = document.getElementById('searchVenta').value.toLowerCase();
                
                document.querySelectorAll('#ventasTableBody tr').forEach(row => {
                    const clienteNombre = row.cells[2].textContent.toLowerCase();
                    
                    if (clienteNombre.includes(searchTerm) || searchTerm === '') {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
            
            // Cerrar modales
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('close') || e.target.classList.contains('close-modal')) {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }
            });
            
            // Cerrar modales al hacer clic fuera de ellos
            window.addEventListener('click', function(e) {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
        });
    </script>
</body>
</html>